<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SillyTavern兼容性测试</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background: #f5f5f5;
        }
        
        h1 {
            color: #333;
            border-bottom: 2px solid #3b82f6;
            padding-bottom: 10px;
        }
        
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-item {
            margin: 15px 0;
            padding: 10px;
            border-left: 3px solid #ddd;
            background: #f9f9f9;
        }
        
        .test-item.pass {
            border-left-color: #10b981;
            background: #f0fdf4;
        }
        
        .test-item.fail {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        
        .test-item.pending {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }
        
        .status {
            font-weight: bold;
            margin-right: 10px;
        }
        
        .status.pass { color: #10b981; }
        .status.fail { color: #ef4444; }
        .status.pending { color: #f59e0b; }
        
        .test-result {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.05);
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        button {
            padding: 8px 16px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        button:hover {
            background: #2563eb;
        }
        
        .summary {
            margin-top: 30px;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #3b82f6 100%);
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <h1>🔍 SillyTavern 兼容性测试套件</h1>
    
    <div class="test-section">
        <h2>1️⃣ 角色卡测试 (Character Cards)</h2>
        <div class="test-item pending" id="test-char-export">
            <span class="status pending">⏳ 待测试</span>
            <strong>角色卡导出格式</strong>
            <div>验证导出的角色卡是否符合 spec_v2 标准</div>
            <button onclick="testCharacterExport()">运行测试</button>
            <div class="test-result" style="display:none;"></div>
        </div>
        
        <div class="test-item pending" id="test-char-import">
            <span class="status pending">⏳ 待测试</span>
            <strong>角色卡导入兼容性</strong>
            <div>验证是否能正确导入 SillyTavern 格式的角色卡</div>
            <button onclick="testCharacterImport()">运行测试</button>
            <div class="test-result" style="display:none;"></div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>2️⃣ 世界书测试 (World Books)</h2>
        <div class="test-item pending" id="test-world-export">
            <span class="status pending">⏳ 待测试</span>
            <strong>世界书导出格式</strong>
            <div>验证导出的世界书格式是否兼容</div>
            <button onclick="testWorldBookExport()">运行测试</button>
            <div class="test-result" style="display:none;"></div>
        </div>
        
        <div class="test-item pending" id="test-world-import">
            <span class="status pending">⏳ 待测试</span>
            <strong>世界书导入兼容性</strong>
            <div>验证是否能正确导入 SillyTavern 格式的世界书</div>
            <button onclick="testWorldBookImport()">运行测试</button>
            <div class="test-result" style="display:none;"></div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>3️⃣ 预设测试 (Presets)</h2>
        <div class="test-item pending" id="test-preset-export">
            <span class="status pending">⏳ 待测试</span>
            <strong>预设导出格式</strong>
            <div>验证导出的预设格式是否兼容</div>
            <button onclick="testPresetExport()">运行测试</button>
            <div class="test-result" style="display:none;"></div>
        </div>
        
        <div class="test-item pending" id="test-preset-import">
            <span class="status pending">⏳ 待测试</span>
            <strong>预设导入兼容性</strong>
            <div>验证是否能正确导入 SillyTavern 格式的预设</div>
            <button onclick="testPresetImport()">运行测试</button>
            <div class="test-result" style="display:none;"></div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>4️⃣ 用户身份测试 (User Persona)</h2>
        <div class="test-item pending" id="test-user-variable">
            <span class="status pending">⏳ 待测试</span>
            <strong>{{user}} 变量替换</strong>
            <div>验证 {{user}} 变量是否正确替换</div>
            <button onclick="testUserVariable()">运行测试</button>
            <div class="test-result" style="display:none;"></div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>5️⃣ 数据整合测试 (Data Integration)</h2>
        <div class="test-item pending" id="test-message-build">
            <span class="status pending">⏳ 待测试</span>
            <strong>消息构建完整性</strong>
            <div>验证所有组件是否正确整合到对话请求中</div>
            <button onclick="testMessageBuilding()">运行测试</button>
            <div class="test-result" style="display:none;"></div>
        </div>
    </div>
    
    <div class="summary">
        <h2>📊 测试摘要</h2>
        <div class="progress-bar">
            <div class="progress-fill" id="progress" style="width: 0%;"></div>
        </div>
        <div id="summary-text">
            <p>总计: <strong>8</strong> 个测试</p>
            <p>✅ 通过: <strong id="pass-count">0</strong></p>
            <p>❌ 失败: <strong id="fail-count">0</strong></p>
            <p>⏳ 待测: <strong id="pending-count">8</strong></p>
        </div>
        <button onclick="runAllTests()">🚀 运行所有测试</button>
        <button onclick="exportTestReport()">📄 导出测试报告</button>
    </div>
    
    <script>
        // 测试结果统计
        let testResults = {
            pass: 0,
            fail: 0,
            pending: 8,
            total: 8
        };
        
        // 更新测试状态
        function updateTestStatus(testId, status, message) {
            const testItem = document.getElementById(testId);
            const statusSpan = testItem.querySelector('.status');
            const resultDiv = testItem.querySelector('.test-result');
            
            // 更新状态类
            testItem.className = 'test-item ' + status;
            statusSpan.className = 'status ' + status;
            
            // 更新状态文字
            if (status === 'pass') {
                statusSpan.textContent = '✅ 通过';
                testResults.pass++;
                testResults.pending--;
            } else if (status === 'fail') {
                statusSpan.textContent = '❌ 失败';
                testResults.fail++;
                testResults.pending--;
            }
            
            // 显示测试结果
            if (message) {
                resultDiv.textContent = message;
                resultDiv.style.display = 'block';
            }
            
            // 更新摘要
            updateSummary();
        }
        
        // 更新摘要
        function updateSummary() {
            document.getElementById('pass-count').textContent = testResults.pass;
            document.getElementById('fail-count').textContent = testResults.fail;
            document.getElementById('pending-count').textContent = testResults.pending;
            
            const progress = ((testResults.pass + testResults.fail) / testResults.total) * 100;
            document.getElementById('progress').style.width = progress + '%';
        }
        
        // 测试角色卡导出
        function testCharacterExport() {
            try {
                const testChar = {
                    name: "测试角色",
                    description: "这是一个测试角色",
                    personality: "友好",
                    scenario: "测试场景",
                    first_mes: "你好！",
                    mes_example: "{{user}}: 你好\n{{char}}: 你好！"
                };
                
                // 模拟导出数据结构
                const exportData = {
                    spec: 'chara_card_v2',
                    spec_version: '2.0',
                    data: {
                        name: testChar.name,
                        description: testChar.description,
                        personality: testChar.personality,
                        scenario: testChar.scenario,
                        first_mes: testChar.first_mes,
                        mes_example: testChar.mes_example,
                        creator_notes: '',
                        system_prompt: '',
                        post_history_instructions: '',
                        alternate_greetings: [],
                        character_book: null,
                        tags: [],
                        creator: 'user',
                        character_version: '1.0',
                        extensions: {}
                    },
                    create_date: new Date().toISOString()
                };
                
                // 验证必要字段
                if (exportData.spec === 'chara_card_v2' && 
                    exportData.spec_version === '2.0' &&
                    exportData.data && 
                    exportData.data.name) {
                    updateTestStatus('test-char-export', 'pass', 
                        'JSON 结构:\n' + JSON.stringify(exportData, null, 2).substring(0, 500) + '...');
                } else {
                    updateTestStatus('test-char-export', 'fail', '导出格式不符合 spec_v2 标准');
                }
            } catch (error) {
                updateTestStatus('test-char-export', 'fail', '测试出错: ' + error.message);
            }
        }
        
        // 测试角色卡导入
        function testCharacterImport() {
            try {
                // 模拟 SillyTavern 格式数据
                const sillyTavernChar = {
                    "spec": "chara_card_v2",
                    "spec_version": "2.0",
                    "data": {
                        "name": "Alice",
                        "description": "A cheerful assistant",
                        "personality": "Friendly and helpful",
                        "scenario": "You meet Alice in a virtual world",
                        "first_mes": "Hello! I'm Alice.",
                        "mes_example": "{{user}}: Hi\n{{char}}: Hello there!",
                        "creator_notes": "Test character",
                        "system_prompt": "",
                        "post_history_instructions": "",
                        "alternate_greetings": [],
                        "character_book": null,
                        "tags": ["assistant", "friendly"],
                        "creator": "TestUser",
                        "character_version": "1.0"
                    }
                };
                
                // 模拟导入处理
                let character;
                if (sillyTavernChar.spec === 'chara_card_v2' && sillyTavernChar.data) {
                    character = sillyTavernChar.data;
                    character.spec = sillyTavernChar.spec;
                    character.spec_version = sillyTavernChar.spec_version;
                }
                
                if (character && character.name === "Alice") {
                    updateTestStatus('test-char-import', 'pass', 
                        '成功导入角色: ' + character.name + '\n描述: ' + character.description);
                } else {
                    updateTestStatus('test-char-import', 'fail', '导入失败');
                }
            } catch (error) {
                updateTestStatus('test-char-import', 'fail', '测试出错: ' + error.message);
            }
        }
        
        // 测试世界书导出
        function testWorldBookExport() {
            try {
                const testEntries = [{
                    id: 'world_001',
                    keys: ['测试', 'test'],
                    content: '这是测试内容',
                    order: 100,
                    enabled: true,
                    position: 'before',
                    depth: 0,
                    title: '测试条目'
                }];
                
                const exportData = {
                    entries: testEntries,
                    world_info: testEntries.map(entry => ({
                        key: entry.keys,
                        entry: entry.content,
                        insertion_order: entry.order,
                        enabled: entry.enabled,
                        comment: entry.title,
                        extensions: {
                            position: entry.position,
                            depth: entry.depth
                        }
                    }))
                };
                
                if (exportData.world_info && exportData.world_info[0].key) {
                    updateTestStatus('test-world-export', 'pass', 
                        'JSON 结构:\n' + JSON.stringify(exportData, null, 2).substring(0, 400));
                } else {
                    updateTestStatus('test-world-export', 'fail', '导出格式不兼容');
                }
            } catch (error) {
                updateTestStatus('test-world-export', 'fail', '测试出错: ' + error.message);
            }
        }
        
        // 测试世界书导入
        function testWorldBookImport() {
            try {
                const sillyTavernWorld = {
                    "world_info": [{
                        "key": ["magic", "spell"],
                        "entry": "Magic exists in this world",
                        "insertion_order": 100,
                        "enabled": true,
                        "comment": "Magic System"
                    }]
                };
                
                let entries = [];
                if (sillyTavernWorld.world_info && Array.isArray(sillyTavernWorld.world_info)) {
                    entries = sillyTavernWorld.world_info;
                }
                
                if (entries.length > 0 && entries[0].key) {
                    updateTestStatus('test-world-import', 'pass', 
                        '成功导入 ' + entries.length + ' 个世界书条目');
                } else {
                    updateTestStatus('test-world-import', 'fail', '导入失败');
                }
            } catch (error) {
                updateTestStatus('test-world-import', 'fail', '测试出错: ' + error.message);
            }
        }
        
        // 测试预设导出
        function testPresetExport() {
            try {
                const testPreset = {
                    prompts: [
                        {
                            identifier: 'main',
                            name: '主提示词',
                            content: '你是一个有帮助的助手',
                            enabled: true,
                            marker: false
                        }
                    ],
                    prompt_order: [
                        { identifier: 'main', enabled: true },
                        { identifier: 'worldInfoBefore', enabled: true },
                        { identifier: 'charDescription', enabled: true }
                    ]
                };
                
                if (testPreset.prompts && testPreset.prompt_order) {
                    updateTestStatus('test-preset-export', 'pass', 
                        'JSON 结构:\n' + JSON.stringify(testPreset, null, 2).substring(0, 400));
                } else {
                    updateTestStatus('test-preset-export', 'fail', '导出格式不兼容');
                }
            } catch (error) {
                updateTestStatus('test-preset-export', 'fail', '测试出错: ' + error.message);
            }
        }
        
        // 测试预设导入
        function testPresetImport() {
            try {
                const sillyTavernPreset = {
                    "prompts": [
                        {
                            "identifier": "main",
                            "name": "Main Prompt",
                            "content": "You are a helpful assistant",
                            "enabled": true
                        }
                    ],
                    "prompt_order": [
                        { "identifier": "main", "enabled": true }
                    ]
                };
                
                if (sillyTavernPreset.prompts && sillyTavernPreset.prompts[0].identifier === 'main') {
                    updateTestStatus('test-preset-import', 'pass', 
                        '成功导入预设，包含 ' + sillyTavernPreset.prompts.length + ' 个提示词');
                } else {
                    updateTestStatus('test-preset-import', 'fail', '导入失败');
                }
            } catch (error) {
                updateTestStatus('test-preset-import', 'fail', '测试出错: ' + error.message);
            }
        }
        
        // 测试用户变量
        function testUserVariable() {
            try {
                const testContent = "Hello {{user}}, I am {{char}}";
                const userSettings = {
                    userName: 'TestUser',
                    persona: 'A curious explorer'
                };
                const character = { name: 'Alice' };
                
                let result = testContent
                    .replace(/\{\{user\}\}/g, userSettings.userName)
                    .replace(/\{\{char\}\}/g, character.name);
                
                if (result === "Hello TestUser, I am Alice") {
                    updateTestStatus('test-user-variable', 'pass', 
                        '变量替换成功:\n原文: ' + testContent + '\n结果: ' + result);
                } else {
                    updateTestStatus('test-user-variable', 'fail', '变量替换失败');
                }
            } catch (error) {
                updateTestStatus('test-user-variable', 'fail', '测试出错: ' + error.message);
            }
        }
        
        // 测试消息构建
        function testMessageBuilding() {
            try {
                const components = {
                    character: { name: 'Alice', description: 'Helpful AI' },
                    worldInfo: { before: 'World context', after: '' },
                    userSettings: { userName: 'User', persona: 'Curious person' },
                    prompts: true
                };
                
                // 验证所有组件是否存在
                if (components.character && 
                    components.worldInfo && 
                    components.userSettings && 
                    components.prompts) {
                    updateTestStatus('test-message-build', 'pass', 
                        '所有组件已整合:\n- 角色: ' + components.character.name + 
                        '\n- 世界书: ✓\n- 用户设置: ' + components.userSettings.userName + 
                        '\n- 提示词: ✓');
                } else {
                    updateTestStatus('test-message-build', 'fail', '组件整合不完整');
                }
            } catch (error) {
                updateTestStatus('test-message-build', 'fail', '测试出错: ' + error.message);
            }
        }
        
        // 运行所有测试
        function runAllTests() {
            // 重置计数
            testResults = {
                pass: 0,
                fail: 0,
                pending: 8,
                total: 8
            };
            
            // 运行所有测试
            setTimeout(() => testCharacterExport(), 100);
            setTimeout(() => testCharacterImport(), 300);
            setTimeout(() => testWorldBookExport(), 500);
            setTimeout(() => testWorldBookImport(), 700);
            setTimeout(() => testPresetExport(), 900);
            setTimeout(() => testPresetImport(), 1100);
            setTimeout(() => testUserVariable(), 1300);
            setTimeout(() => testMessageBuilding(), 1500);
        }
        
        // 导出测试报告
        function exportTestReport() {
            const report = {
                testDate: new Date().toISOString(),
                summary: {
                    total: testResults.total,
                    pass: testResults.pass,
                    fail: testResults.fail,
                    pending: testResults.pending,
                    passRate: ((testResults.pass / testResults.total) * 100).toFixed(2) + '%'
                },
                tests: [
                    { name: '角色卡导出格式', status: document.getElementById('test-char-export').className.split(' ')[1] },
                    { name: '角色卡导入兼容性', status: document.getElementById('test-char-import').className.split(' ')[1] },
                    { name: '世界书导出格式', status: document.getElementById('test-world-export').className.split(' ')[1] },
                    { name: '世界书导入兼容性', status: document.getElementById('test-world-import').className.split(' ')[1] },
                    { name: '预设导出格式', status: document.getElementById('test-preset-export').className.split(' ')[1] },
                    { name: '预设导入兼容性', status: document.getElementById('test-preset-import').className.split(' ')[1] },
                    { name: '{{user}}变量替换', status: document.getElementById('test-user-variable').className.split(' ')[1] },
                    { name: '消息构建完整性', status: document.getElementById('test-message-build').className.split(' ')[1] }
                ]
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `compatibility_test_report_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>