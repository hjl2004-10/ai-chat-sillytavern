<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SillyTavernå…¼å®¹æ€§æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background: #f5f5f5;
        }
        
        h1 {
            color: #333;
            border-bottom: 2px solid #3b82f6;
            padding-bottom: 10px;
        }
        
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-item {
            margin: 15px 0;
            padding: 10px;
            border-left: 3px solid #ddd;
            background: #f9f9f9;
        }
        
        .test-item.pass {
            border-left-color: #10b981;
            background: #f0fdf4;
        }
        
        .test-item.fail {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        
        .test-item.pending {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }
        
        .status {
            font-weight: bold;
            margin-right: 10px;
        }
        
        .status.pass { color: #10b981; }
        .status.fail { color: #ef4444; }
        .status.pending { color: #f59e0b; }
        
        .test-result {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.05);
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        button {
            padding: 8px 16px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        button:hover {
            background: #2563eb;
        }
        
        .summary {
            margin-top: 30px;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #3b82f6 100%);
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <h1>ğŸ” SillyTavern å…¼å®¹æ€§æµ‹è¯•å¥—ä»¶</h1>
    
    <div class="test-section">
        <h2>1ï¸âƒ£ è§’è‰²å¡æµ‹è¯• (Character Cards)</h2>
        <div class="test-item pending" id="test-char-export">
            <span class="status pending">â³ å¾…æµ‹è¯•</span>
            <strong>è§’è‰²å¡å¯¼å‡ºæ ¼å¼</strong>
            <div>éªŒè¯å¯¼å‡ºçš„è§’è‰²å¡æ˜¯å¦ç¬¦åˆ spec_v2 æ ‡å‡†</div>
            <button onclick="testCharacterExport()">è¿è¡Œæµ‹è¯•</button>
            <div class="test-result" style="display:none;"></div>
        </div>
        
        <div class="test-item pending" id="test-char-import">
            <span class="status pending">â³ å¾…æµ‹è¯•</span>
            <strong>è§’è‰²å¡å¯¼å…¥å…¼å®¹æ€§</strong>
            <div>éªŒè¯æ˜¯å¦èƒ½æ­£ç¡®å¯¼å…¥ SillyTavern æ ¼å¼çš„è§’è‰²å¡</div>
            <button onclick="testCharacterImport()">è¿è¡Œæµ‹è¯•</button>
            <div class="test-result" style="display:none;"></div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>2ï¸âƒ£ ä¸–ç•Œä¹¦æµ‹è¯• (World Books)</h2>
        <div class="test-item pending" id="test-world-export">
            <span class="status pending">â³ å¾…æµ‹è¯•</span>
            <strong>ä¸–ç•Œä¹¦å¯¼å‡ºæ ¼å¼</strong>
            <div>éªŒè¯å¯¼å‡ºçš„ä¸–ç•Œä¹¦æ ¼å¼æ˜¯å¦å…¼å®¹</div>
            <button onclick="testWorldBookExport()">è¿è¡Œæµ‹è¯•</button>
            <div class="test-result" style="display:none;"></div>
        </div>
        
        <div class="test-item pending" id="test-world-import">
            <span class="status pending">â³ å¾…æµ‹è¯•</span>
            <strong>ä¸–ç•Œä¹¦å¯¼å…¥å…¼å®¹æ€§</strong>
            <div>éªŒè¯æ˜¯å¦èƒ½æ­£ç¡®å¯¼å…¥ SillyTavern æ ¼å¼çš„ä¸–ç•Œä¹¦</div>
            <button onclick="testWorldBookImport()">è¿è¡Œæµ‹è¯•</button>
            <div class="test-result" style="display:none;"></div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>3ï¸âƒ£ é¢„è®¾æµ‹è¯• (Presets)</h2>
        <div class="test-item pending" id="test-preset-export">
            <span class="status pending">â³ å¾…æµ‹è¯•</span>
            <strong>é¢„è®¾å¯¼å‡ºæ ¼å¼</strong>
            <div>éªŒè¯å¯¼å‡ºçš„é¢„è®¾æ ¼å¼æ˜¯å¦å…¼å®¹</div>
            <button onclick="testPresetExport()">è¿è¡Œæµ‹è¯•</button>
            <div class="test-result" style="display:none;"></div>
        </div>
        
        <div class="test-item pending" id="test-preset-import">
            <span class="status pending">â³ å¾…æµ‹è¯•</span>
            <strong>é¢„è®¾å¯¼å…¥å…¼å®¹æ€§</strong>
            <div>éªŒè¯æ˜¯å¦èƒ½æ­£ç¡®å¯¼å…¥ SillyTavern æ ¼å¼çš„é¢„è®¾</div>
            <button onclick="testPresetImport()">è¿è¡Œæµ‹è¯•</button>
            <div class="test-result" style="display:none;"></div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>4ï¸âƒ£ ç”¨æˆ·èº«ä»½æµ‹è¯• (User Persona)</h2>
        <div class="test-item pending" id="test-user-variable">
            <span class="status pending">â³ å¾…æµ‹è¯•</span>
            <strong>{{user}} å˜é‡æ›¿æ¢</strong>
            <div>éªŒè¯ {{user}} å˜é‡æ˜¯å¦æ­£ç¡®æ›¿æ¢</div>
            <button onclick="testUserVariable()">è¿è¡Œæµ‹è¯•</button>
            <div class="test-result" style="display:none;"></div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>5ï¸âƒ£ æ•°æ®æ•´åˆæµ‹è¯• (Data Integration)</h2>
        <div class="test-item pending" id="test-message-build">
            <span class="status pending">â³ å¾…æµ‹è¯•</span>
            <strong>æ¶ˆæ¯æ„å»ºå®Œæ•´æ€§</strong>
            <div>éªŒè¯æ‰€æœ‰ç»„ä»¶æ˜¯å¦æ­£ç¡®æ•´åˆåˆ°å¯¹è¯è¯·æ±‚ä¸­</div>
            <button onclick="testMessageBuilding()">è¿è¡Œæµ‹è¯•</button>
            <div class="test-result" style="display:none;"></div>
        </div>
    </div>
    
    <div class="summary">
        <h2>ğŸ“Š æµ‹è¯•æ‘˜è¦</h2>
        <div class="progress-bar">
            <div class="progress-fill" id="progress" style="width: 0%;"></div>
        </div>
        <div id="summary-text">
            <p>æ€»è®¡: <strong>8</strong> ä¸ªæµ‹è¯•</p>
            <p>âœ… é€šè¿‡: <strong id="pass-count">0</strong></p>
            <p>âŒ å¤±è´¥: <strong id="fail-count">0</strong></p>
            <p>â³ å¾…æµ‹: <strong id="pending-count">8</strong></p>
        </div>
        <button onclick="runAllTests()">ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
        <button onclick="exportTestReport()">ğŸ“„ å¯¼å‡ºæµ‹è¯•æŠ¥å‘Š</button>
    </div>
    
    <script>
        // æµ‹è¯•ç»“æœç»Ÿè®¡
        let testResults = {
            pass: 0,
            fail: 0,
            pending: 8,
            total: 8
        };
        
        // æ›´æ–°æµ‹è¯•çŠ¶æ€
        function updateTestStatus(testId, status, message) {
            const testItem = document.getElementById(testId);
            const statusSpan = testItem.querySelector('.status');
            const resultDiv = testItem.querySelector('.test-result');
            
            // æ›´æ–°çŠ¶æ€ç±»
            testItem.className = 'test-item ' + status;
            statusSpan.className = 'status ' + status;
            
            // æ›´æ–°çŠ¶æ€æ–‡å­—
            if (status === 'pass') {
                statusSpan.textContent = 'âœ… é€šè¿‡';
                testResults.pass++;
                testResults.pending--;
            } else if (status === 'fail') {
                statusSpan.textContent = 'âŒ å¤±è´¥';
                testResults.fail++;
                testResults.pending--;
            }
            
            // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
            if (message) {
                resultDiv.textContent = message;
                resultDiv.style.display = 'block';
            }
            
            // æ›´æ–°æ‘˜è¦
            updateSummary();
        }
        
        // æ›´æ–°æ‘˜è¦
        function updateSummary() {
            document.getElementById('pass-count').textContent = testResults.pass;
            document.getElementById('fail-count').textContent = testResults.fail;
            document.getElementById('pending-count').textContent = testResults.pending;
            
            const progress = ((testResults.pass + testResults.fail) / testResults.total) * 100;
            document.getElementById('progress').style.width = progress + '%';
        }
        
        // æµ‹è¯•è§’è‰²å¡å¯¼å‡º
        function testCharacterExport() {
            try {
                const testChar = {
                    name: "æµ‹è¯•è§’è‰²",
                    description: "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•è§’è‰²",
                    personality: "å‹å¥½",
                    scenario: "æµ‹è¯•åœºæ™¯",
                    first_mes: "ä½ å¥½ï¼",
                    mes_example: "{{user}}: ä½ å¥½\n{{char}}: ä½ å¥½ï¼"
                };
                
                // æ¨¡æ‹Ÿå¯¼å‡ºæ•°æ®ç»“æ„
                const exportData = {
                    spec: 'chara_card_v2',
                    spec_version: '2.0',
                    data: {
                        name: testChar.name,
                        description: testChar.description,
                        personality: testChar.personality,
                        scenario: testChar.scenario,
                        first_mes: testChar.first_mes,
                        mes_example: testChar.mes_example,
                        creator_notes: '',
                        system_prompt: '',
                        post_history_instructions: '',
                        alternate_greetings: [],
                        character_book: null,
                        tags: [],
                        creator: 'user',
                        character_version: '1.0',
                        extensions: {}
                    },
                    create_date: new Date().toISOString()
                };
                
                // éªŒè¯å¿…è¦å­—æ®µ
                if (exportData.spec === 'chara_card_v2' && 
                    exportData.spec_version === '2.0' &&
                    exportData.data && 
                    exportData.data.name) {
                    updateTestStatus('test-char-export', 'pass', 
                        'JSON ç»“æ„:\n' + JSON.stringify(exportData, null, 2).substring(0, 500) + '...');
                } else {
                    updateTestStatus('test-char-export', 'fail', 'å¯¼å‡ºæ ¼å¼ä¸ç¬¦åˆ spec_v2 æ ‡å‡†');
                }
            } catch (error) {
                updateTestStatus('test-char-export', 'fail', 'æµ‹è¯•å‡ºé”™: ' + error.message);
            }
        }
        
        // æµ‹è¯•è§’è‰²å¡å¯¼å…¥
        function testCharacterImport() {
            try {
                // æ¨¡æ‹Ÿ SillyTavern æ ¼å¼æ•°æ®
                const sillyTavernChar = {
                    "spec": "chara_card_v2",
                    "spec_version": "2.0",
                    "data": {
                        "name": "Alice",
                        "description": "A cheerful assistant",
                        "personality": "Friendly and helpful",
                        "scenario": "You meet Alice in a virtual world",
                        "first_mes": "Hello! I'm Alice.",
                        "mes_example": "{{user}}: Hi\n{{char}}: Hello there!",
                        "creator_notes": "Test character",
                        "system_prompt": "",
                        "post_history_instructions": "",
                        "alternate_greetings": [],
                        "character_book": null,
                        "tags": ["assistant", "friendly"],
                        "creator": "TestUser",
                        "character_version": "1.0"
                    }
                };
                
                // æ¨¡æ‹Ÿå¯¼å…¥å¤„ç†
                let character;
                if (sillyTavernChar.spec === 'chara_card_v2' && sillyTavernChar.data) {
                    character = sillyTavernChar.data;
                    character.spec = sillyTavernChar.spec;
                    character.spec_version = sillyTavernChar.spec_version;
                }
                
                if (character && character.name === "Alice") {
                    updateTestStatus('test-char-import', 'pass', 
                        'æˆåŠŸå¯¼å…¥è§’è‰²: ' + character.name + '\næè¿°: ' + character.description);
                } else {
                    updateTestStatus('test-char-import', 'fail', 'å¯¼å…¥å¤±è´¥');
                }
            } catch (error) {
                updateTestStatus('test-char-import', 'fail', 'æµ‹è¯•å‡ºé”™: ' + error.message);
            }
        }
        
        // æµ‹è¯•ä¸–ç•Œä¹¦å¯¼å‡º
        function testWorldBookExport() {
            try {
                const testEntries = [{
                    id: 'world_001',
                    keys: ['æµ‹è¯•', 'test'],
                    content: 'è¿™æ˜¯æµ‹è¯•å†…å®¹',
                    order: 100,
                    enabled: true,
                    position: 'before',
                    depth: 0,
                    title: 'æµ‹è¯•æ¡ç›®'
                }];
                
                const exportData = {
                    entries: testEntries,
                    world_info: testEntries.map(entry => ({
                        key: entry.keys,
                        entry: entry.content,
                        insertion_order: entry.order,
                        enabled: entry.enabled,
                        comment: entry.title,
                        extensions: {
                            position: entry.position,
                            depth: entry.depth
                        }
                    }))
                };
                
                if (exportData.world_info && exportData.world_info[0].key) {
                    updateTestStatus('test-world-export', 'pass', 
                        'JSON ç»“æ„:\n' + JSON.stringify(exportData, null, 2).substring(0, 400));
                } else {
                    updateTestStatus('test-world-export', 'fail', 'å¯¼å‡ºæ ¼å¼ä¸å…¼å®¹');
                }
            } catch (error) {
                updateTestStatus('test-world-export', 'fail', 'æµ‹è¯•å‡ºé”™: ' + error.message);
            }
        }
        
        // æµ‹è¯•ä¸–ç•Œä¹¦å¯¼å…¥
        function testWorldBookImport() {
            try {
                const sillyTavernWorld = {
                    "world_info": [{
                        "key": ["magic", "spell"],
                        "entry": "Magic exists in this world",
                        "insertion_order": 100,
                        "enabled": true,
                        "comment": "Magic System"
                    }]
                };
                
                let entries = [];
                if (sillyTavernWorld.world_info && Array.isArray(sillyTavernWorld.world_info)) {
                    entries = sillyTavernWorld.world_info;
                }
                
                if (entries.length > 0 && entries[0].key) {
                    updateTestStatus('test-world-import', 'pass', 
                        'æˆåŠŸå¯¼å…¥ ' + entries.length + ' ä¸ªä¸–ç•Œä¹¦æ¡ç›®');
                } else {
                    updateTestStatus('test-world-import', 'fail', 'å¯¼å…¥å¤±è´¥');
                }
            } catch (error) {
                updateTestStatus('test-world-import', 'fail', 'æµ‹è¯•å‡ºé”™: ' + error.message);
            }
        }
        
        // æµ‹è¯•é¢„è®¾å¯¼å‡º
        function testPresetExport() {
            try {
                const testPreset = {
                    prompts: [
                        {
                            identifier: 'main',
                            name: 'ä¸»æç¤ºè¯',
                            content: 'ä½ æ˜¯ä¸€ä¸ªæœ‰å¸®åŠ©çš„åŠ©æ‰‹',
                            enabled: true,
                            marker: false
                        }
                    ],
                    prompt_order: [
                        { identifier: 'main', enabled: true },
                        { identifier: 'worldInfoBefore', enabled: true },
                        { identifier: 'charDescription', enabled: true }
                    ]
                };
                
                if (testPreset.prompts && testPreset.prompt_order) {
                    updateTestStatus('test-preset-export', 'pass', 
                        'JSON ç»“æ„:\n' + JSON.stringify(testPreset, null, 2).substring(0, 400));
                } else {
                    updateTestStatus('test-preset-export', 'fail', 'å¯¼å‡ºæ ¼å¼ä¸å…¼å®¹');
                }
            } catch (error) {
                updateTestStatus('test-preset-export', 'fail', 'æµ‹è¯•å‡ºé”™: ' + error.message);
            }
        }
        
        // æµ‹è¯•é¢„è®¾å¯¼å…¥
        function testPresetImport() {
            try {
                const sillyTavernPreset = {
                    "prompts": [
                        {
                            "identifier": "main",
                            "name": "Main Prompt",
                            "content": "You are a helpful assistant",
                            "enabled": true
                        }
                    ],
                    "prompt_order": [
                        { "identifier": "main", "enabled": true }
                    ]
                };
                
                if (sillyTavernPreset.prompts && sillyTavernPreset.prompts[0].identifier === 'main') {
                    updateTestStatus('test-preset-import', 'pass', 
                        'æˆåŠŸå¯¼å…¥é¢„è®¾ï¼ŒåŒ…å« ' + sillyTavernPreset.prompts.length + ' ä¸ªæç¤ºè¯');
                } else {
                    updateTestStatus('test-preset-import', 'fail', 'å¯¼å…¥å¤±è´¥');
                }
            } catch (error) {
                updateTestStatus('test-preset-import', 'fail', 'æµ‹è¯•å‡ºé”™: ' + error.message);
            }
        }
        
        // æµ‹è¯•ç”¨æˆ·å˜é‡
        function testUserVariable() {
            try {
                const testContent = "Hello {{user}}, I am {{char}}";
                const userSettings = {
                    userName: 'TestUser',
                    persona: 'A curious explorer'
                };
                const character = { name: 'Alice' };
                
                let result = testContent
                    .replace(/\{\{user\}\}/g, userSettings.userName)
                    .replace(/\{\{char\}\}/g, character.name);
                
                if (result === "Hello TestUser, I am Alice") {
                    updateTestStatus('test-user-variable', 'pass', 
                        'å˜é‡æ›¿æ¢æˆåŠŸ:\nåŸæ–‡: ' + testContent + '\nç»“æœ: ' + result);
                } else {
                    updateTestStatus('test-user-variable', 'fail', 'å˜é‡æ›¿æ¢å¤±è´¥');
                }
            } catch (error) {
                updateTestStatus('test-user-variable', 'fail', 'æµ‹è¯•å‡ºé”™: ' + error.message);
            }
        }
        
        // æµ‹è¯•æ¶ˆæ¯æ„å»º
        function testMessageBuilding() {
            try {
                const components = {
                    character: { name: 'Alice', description: 'Helpful AI' },
                    worldInfo: { before: 'World context', after: '' },
                    userSettings: { userName: 'User', persona: 'Curious person' },
                    prompts: true
                };
                
                // éªŒè¯æ‰€æœ‰ç»„ä»¶æ˜¯å¦å­˜åœ¨
                if (components.character && 
                    components.worldInfo && 
                    components.userSettings && 
                    components.prompts) {
                    updateTestStatus('test-message-build', 'pass', 
                        'æ‰€æœ‰ç»„ä»¶å·²æ•´åˆ:\n- è§’è‰²: ' + components.character.name + 
                        '\n- ä¸–ç•Œä¹¦: âœ“\n- ç”¨æˆ·è®¾ç½®: ' + components.userSettings.userName + 
                        '\n- æç¤ºè¯: âœ“');
                } else {
                    updateTestStatus('test-message-build', 'fail', 'ç»„ä»¶æ•´åˆä¸å®Œæ•´');
                }
            } catch (error) {
                updateTestStatus('test-message-build', 'fail', 'æµ‹è¯•å‡ºé”™: ' + error.message);
            }
        }
        
        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        function runAllTests() {
            // é‡ç½®è®¡æ•°
            testResults = {
                pass: 0,
                fail: 0,
                pending: 8,
                total: 8
            };
            
            // è¿è¡Œæ‰€æœ‰æµ‹è¯•
            setTimeout(() => testCharacterExport(), 100);
            setTimeout(() => testCharacterImport(), 300);
            setTimeout(() => testWorldBookExport(), 500);
            setTimeout(() => testWorldBookImport(), 700);
            setTimeout(() => testPresetExport(), 900);
            setTimeout(() => testPresetImport(), 1100);
            setTimeout(() => testUserVariable(), 1300);
            setTimeout(() => testMessageBuilding(), 1500);
        }
        
        // å¯¼å‡ºæµ‹è¯•æŠ¥å‘Š
        function exportTestReport() {
            const report = {
                testDate: new Date().toISOString(),
                summary: {
                    total: testResults.total,
                    pass: testResults.pass,
                    fail: testResults.fail,
                    pending: testResults.pending,
                    passRate: ((testResults.pass / testResults.total) * 100).toFixed(2) + '%'
                },
                tests: [
                    { name: 'è§’è‰²å¡å¯¼å‡ºæ ¼å¼', status: document.getElementById('test-char-export').className.split(' ')[1] },
                    { name: 'è§’è‰²å¡å¯¼å…¥å…¼å®¹æ€§', status: document.getElementById('test-char-import').className.split(' ')[1] },
                    { name: 'ä¸–ç•Œä¹¦å¯¼å‡ºæ ¼å¼', status: document.getElementById('test-world-export').className.split(' ')[1] },
                    { name: 'ä¸–ç•Œä¹¦å¯¼å…¥å…¼å®¹æ€§', status: document.getElementById('test-world-import').className.split(' ')[1] },
                    { name: 'é¢„è®¾å¯¼å‡ºæ ¼å¼', status: document.getElementById('test-preset-export').className.split(' ')[1] },
                    { name: 'é¢„è®¾å¯¼å…¥å…¼å®¹æ€§', status: document.getElementById('test-preset-import').className.split(' ')[1] },
                    { name: '{{user}}å˜é‡æ›¿æ¢', status: document.getElementById('test-user-variable').className.split(' ')[1] },
                    { name: 'æ¶ˆæ¯æ„å»ºå®Œæ•´æ€§', status: document.getElementById('test-message-build').className.split(' ')[1] }
                ]
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `compatibility_test_report_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>